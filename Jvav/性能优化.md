# 性能优化

- [性能优化](#性能优化)
  - [基础](#基础)
    - [jmeter压力测试可能出现的问题](#jmeter压力测试可能出现的问题)
    - [压测工具ab](#压测工具ab)
    - [Redis 压力测试 OutOfDirectMemerory](#redis-压力测试-outofdirectmemerory)
  - [优化](#优化)
  - [slueth & zipkin](#slueth--zipkin)

## 基础

Jconsole & jvisualvm 查看jvm状况

### jmeter压力测试可能出现的问题

- windows 本身提供的端口访问机制的问题。
- Windows 提供给 TCP/IP 链接的端口为 1024-5000，并且要四分钟来循环回收他们。就导致
- 我们在短时间内跑大量的请求时将端口占满了。
  1. cmd 中，用 regedit 命令打开注册表
  2. 在 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters 下，
     1. 右击 parameters，添加一个新的 DWORD，名字为 MaxUserPort
     2. 然后双击 MaxUserPort，输入数值数据为 65534，基数选择十进制（如果是分布式运行的话，控制机器和负载机器都需要这样操作哦）
     3. 修改配置完毕之后记得重启机器才会生效``https://support.microsoft.com/zh-cn/help/196271/when-you-try-to-connect-from-tcp-ports-grea``
        - ter-than-5000-you-receive-t
        - TCPTimedWaitDelay：30

### 压测工具ab

- ab压测 安装 yum install -y httpd-tools
- 测试  ab -n 10000 -c 100 10.211.55.105:8000/product/setNum
- 多个微服务启动 在微服务右键copy configration在program argument里面添加 --server.port=8001 即可启动微服务集群

### Redis 压力测试 OutOfDirectMemerory

- 压力测试会堆外溢出异常, OutOfDirectMemory
- boot2.0用lettuce操作redis的客户端,与netty进行网络通信,lettuce的bug导致netty的问题
- 如果没有指定netty的内存,就会使用该微服务指定的-Xmx100m内存大小,但是没有内存释放
- -Dio.netty.maxDirectMemory  这个可以配置,但是不能只调大对外内存大小,只会延缓问题出现的时间
- 解决方案
  - 升级lettuce客户端
  - 切换使用jedis(老客户端,效率低
- 微服务集群在idea的微服务右键 复制配置,改名字 在Program arguments上面添加--server.port=10002 指定新端口的微服务集群

## 优化

- 应用是 CPU 密集型(大量的计算,排序)还是 IO 密集型(微服务通信io,连接io,网络io,数据库io)
- 减少循环访问数据库,给常用字段添加索引
- 业务代码改造,将数据一次性查出来在内存中进行处理; 方法改造,可以尽量多的复用和少的查询数据库
- 动静分离 将静态资源部署到nginx上(**详细配置看nginx篇**)

    ```conf
    Gulimall.conf中配置如下 要在路径动请求的上面先匹配静态资源
            location /static/ {
                root   /usr/share/nginx/html;}
            location / {
            proxy_set_header Host $host;
            proxy_pass http://gulimall;   }
    ```

- 更改网络传输的文件类型,比如json体积大,传输慢,可以换成别的加密算法

## slueth & zipkin

docker run -d -p 9411:9411 openzipkin/zipkin 导入zipkin,自带slueth,不需要在引入slueth

```xml
<dependency>
<groupId>org.springframework.cloud</groupId>
<artifactId>spring-cloud-starter-zipkin</artifactId>
</dependency>
```

配置

```conf
spring:
  application:
    name: user-service
  zipkin:
    base-url: http://192.168.56.10:9411/ # zipkin 服务器的地址
# 关闭服务发现，否则 Spring Cloud 会把 zipkin 的 url 当做服务名称
    discoveryClientEnabled: false
    sender:
      type: web # 设置使用 http 的方式传输数据
  sleuth:
    sampler:
      probability: 1 # 设置抽样采集率为 100%，默认为 0.1，即 10%
```

数据日志持久化:默认在内存中,推荐弄到es中

docker run --env STORAGE_TYPE=elasticsearch --env ES_HOSTS=192.168.134.12:9200 openzipkin/zipkin-dependencies
